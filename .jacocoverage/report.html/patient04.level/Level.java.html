<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Level.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;EWI3620TU-GROUP04&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">patient04.level</a> &gt; <span class="el_source">Level.java</span></div><h1>Level.java</h1><pre class="source lang-java linenums">package patient04.level;

import patient04.level.elements.*;
import java.io.*;
import java.util.ArrayList;
import org.lwjgl.opengl.GL11;

import patient04.resources.Model;
import patient04.level.elements.Waypoint;
import patient04.rendering.Renderer;
import patient04.utilities.Logger;
import patient04.physics.AABB;
import patient04.math.Vector;
import patient04.physics.Entity;
import patient04.rendering.Light;
import patient04.resources.Sound;
import patient04.resources.Texture;

public class Level {
    // Next subsequent level
    public String nextLevel;    
    
    // Gravity vectors
<span class="nc" id="L24">    public static final Vector GRAVITY = new Vector(0, -1, 0);</span>
    
    // Friction vectors
<span class="nc" id="L27">    public static final Vector FRICTION_FLY = new Vector(0.6f, 0.6f, 0.6f);</span>
<span class="nc" id="L28">    public static final Vector FRICTION_GROUND = new Vector(0.6f, 1, 0.6f);</span>
<span class="nc" id="L29">    public static final Vector FRICTION_AIR = new Vector(0.98f, 0.98f, 0.98f);</span>
    
    // Wall height
    public static final float WALL_HEIGHT = 3f;
    
    private final ArrayList&lt;Solid&gt; solids;
    private final ArrayList&lt;Light&gt; lights;
    private final ArrayList&lt;Entity&gt; entities;
    private final ArrayList&lt;Usable&gt; usables;
    
    public final ArrayList&lt;Waypoint&gt; waypoints;
<span class="nc" id="L40">    public final Vector startPoint = new Vector();</span>
    
    /** Level Constructor
     * 
     */
<span class="nc" id="L45">    public Level() {</span>
<span class="nc" id="L46">        this.solids = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L47">        this.lights = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L48">        this.entities = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L49">        this.waypoints = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L50">        this.usables = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L51">    }</span>
    
    /** Adds a solid to the level
     * 
     * @param solid 
     */
    public void addSolid(Solid solid) {
<span class="nc" id="L58">        solids.add(solid);</span>
<span class="nc" id="L59">    }</span>
    
    /** Adds a usable to the level
     * 
     * @param usable 
     */
    public void addUsable(Usable usable) {
<span class="nc" id="L66">        usables.add(usable);</span>
<span class="nc" id="L67">    }</span>
    
    /** Removes a usable from the level
     * 
     * @param usable 
     */
    public void removeUsable(Usable usable) {
<span class="nc" id="L74">        usables.remove(usable);</span>
<span class="nc" id="L75">    }</span>
    
    /** Returns the usable's in the level
     * 
     * @return ArrayList&lt;Usable&gt; usables 
     */
    public ArrayList&lt;Usable&gt; getUsables() {
<span class="nc" id="L82">        return usables;</span>
    }
    
    /** Adds a new light to the level
     * 
     * @return Light light
     */
    public Light addNewLight() {
<span class="nc" id="L90">        Light light = new Light();</span>
<span class="nc" id="L91">        lights.add(light);</span>
<span class="nc" id="L92">        return light;</span>
    }
    
    /** Adds new entity to the level
     * 
     * @param entity 
     */
    public void addEntity(Entity entity) {
<span class="nc" id="L100">        entities.add(entity);</span>
<span class="nc" id="L101">    }</span>
    
    /** Adds a new Player to the level
     * 
     * @return Player player
     */
    public Player newPlayer() {
<span class="nc" id="L108">        Player player = new Player(this);</span>

        // Add player to the entity list
<span class="nc" id="L111">        addEntity(player);</span>

        // Sets player as target for enemies
<span class="nc bnc" id="L114" title="All 2 branches missed.">        for (Entity entity : entities)</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (entity instanceof Enemy)</span>
<span class="nc" id="L116">                ((Enemy) entity).target = player;</span>

<span class="nc" id="L118">        return player;</span>
    }
    
    /** Adds new wayoint to the level
     * 
     * @param waypoint
     * @return 
     */
    public Waypoint addWaypoint(Waypoint waypoint) {
<span class="nc" id="L127">        waypoints.add(waypoint);</span>
        
<span class="nc" id="L129">        return waypoint;</span>
    }
    
    /** Returns the collision boxes in a broadphase
     * 
     * @param broadphase
     * @return 
     */
    public ArrayList&lt;AABB&gt; getCollisionBoxes(AABB broadphase) {
<span class="nc" id="L138">        ArrayList&lt;AABB&gt; aabbs = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L140" title="All 2 branches missed.">        for (Solid obj : solids) </span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if(broadphase.intersects(obj.aabb))</span>
<span class="nc" id="L142">                aabbs.add(obj.aabb);</span>
        
<span class="nc bnc" id="L144" title="All 2 branches missed.">        for (Usable usable : usables)</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if(broadphase.intersects(usable.getAABB()))</span>
<span class="nc" id="L146">                aabbs.add(usable.getAABB());</span>

<span class="nc" id="L148">        return aabbs;</span>
    }
    
    /** Draws the geometry of the level
     * 
     * @param renderer 
     */
    public void drawGeometry(Renderer renderer) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        for (Solid solid : solids)</span>
<span class="nc" id="L157">            solid.draw(renderer);</span>
        
<span class="nc bnc" id="L159" title="All 2 branches missed.">        for (Entity entity : entities)</span>
<span class="nc" id="L160">            entity.draw(renderer);</span>
        
<span class="nc bnc" id="L162" title="All 2 branches missed.">        for (Usable usable : usables)</span>
<span class="nc" id="L163">            usable.draw(renderer);</span>
<span class="nc" id="L164">    }</span>
    
    /** Draws the lights of the level
     * 
     * @param renderer 
     */
    public void drawLights(Renderer renderer) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for (Light light : lights)</span>
<span class="nc" id="L172">            light.draw(renderer);</span>
        
<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (Entity entity : entities)</span>
<span class="nc" id="L175">            entity.drawLight(renderer);</span>
        
<span class="nc bnc" id="L177" title="All 2 branches missed.">        for (Usable usable : usables)</span>
<span class="nc" id="L178">            usable.drawLight(renderer);</span>
<span class="nc" id="L179">    }</span>
    
    /** Draws the waypoints in the level
     * 
     * @param renderer 
     */
    public void drawNavPoints(Renderer renderer) {
<span class="nc" id="L186">        GL11.glDisable(GL11.GL_TEXTURE_2D);</span>
<span class="nc" id="L187">        GL11.glEnable(GL11.GL_BLEND);</span>
<span class="nc" id="L188">        GL11.glBlendFunc(GL11.GL_SRC_ALPHA, GL11.GL_ONE_MINUS_SRC_ALPHA);</span>
        
<span class="nc" id="L190">        renderer.glUpdateModelMatrix(null);</span>
        
<span class="nc" id="L192">        GL11.glBegin(GL11.GL_LINES);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        for(Waypoint wp : waypoints) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            for(Waypoint np : wp.neighbors) {</span>
<span class="nc" id="L195">                GL11.glColor4f(0, 1, 0, 0.3f);</span>
<span class="nc" id="L196">                GL11.glVertex3f(wp.position.x, wp.position.y, wp.position.z);</span>
<span class="nc" id="L197">                GL11.glVertex3f(np.position.x, np.position.y, np.position.z);</span>
<span class="nc" id="L198">            }</span>
<span class="nc" id="L199">            GL11.glColor4f(1, 0, 0, 0.9f);</span>
<span class="nc" id="L200">            GL11.glVertex3f(wp.position.x, wp.position.y, wp.position.z);</span>
<span class="nc" id="L201">            GL11.glVertex3f(wp.position.x, wp.position.y + 1, wp.position.z);</span>
<span class="nc" id="L202">        }</span>
<span class="nc" id="L203">        GL11.glEnd();</span>
<span class="nc" id="L204">    }</span>
    
    /** Updates the level
     * 
     * @param dt delta time in seconds
     */
    public void update(float dt) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        for (Entity entity : entities)</span>
<span class="nc" id="L212">            entity.update(dt);</span>
        
<span class="nc bnc" id="L214" title="All 2 branches missed.">        for (Usable usable : usables)</span>
<span class="nc" id="L215">            usable.update(dt);</span>
                
<span class="nc bnc" id="L217" title="All 2 branches missed.">        for (Entity entity : entities)</span>
<span class="nc" id="L218">            entity.integrate();</span>
<span class="nc" id="L219">    }</span>
    
    /** Cleans the level
     * 
     */
    public void cleanup() {
<span class="nc" id="L225">        Texture.disposeResources();</span>
<span class="nc" id="L226">        Model.disposeResources();</span>
<span class="nc" id="L227">        Sound.disposeResources();</span>
<span class="nc" id="L228">    }</span>
    
    /** Sets the floor and ceiling of the level
     * 
     * @param floorFile
     * @param ceilingFile 
     */
    public void generateFloorCeiling(String floorFile, String ceilingFile) {
<span class="nc" id="L236">        Float xmin = null, zmin = null,</span>
<span class="nc" id="L237">                xmax = null, zmax = null;</span>
        
<span class="nc bnc" id="L239" title="All 2 branches missed.">        for (Solid obj : solids) {</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">            if(xmin == null || obj.aabb.pos.x + obj.aabb.min.x &lt;  xmin)</span>
<span class="nc" id="L241">                xmin = obj.aabb.pos.x + obj.aabb.min.x;</span>
<span class="nc bnc" id="L242" title="All 4 branches missed.">            if(zmin == null || obj.aabb.pos.z + obj.aabb.min.z &lt;  zmin)</span>
<span class="nc" id="L243">                zmin = obj.aabb.pos.z + obj.aabb.min.z;</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">            if(xmax == null || obj.aabb.pos.x + obj.aabb.max.x &gt;  xmax)</span>
<span class="nc" id="L245">                xmax = obj.aabb.pos.x + obj.aabb.max.x;</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">            if(zmax == null || obj.aabb.pos.z + obj.aabb.max.z &gt;  zmax)</span>
<span class="nc" id="L247">                zmax = obj.aabb.pos.z + obj.aabb.max.z;</span>
<span class="nc" id="L248">        }</span>
        
<span class="nc bnc" id="L250" title="All 8 branches missed.">        if (xmin == null || zmin == null || xmax == null || zmax == null) {</span>
<span class="nc" id="L251">            Logger.error(&quot;Could not generate floor!&quot;);</span>
<span class="nc" id="L252">            return;</span>
        }
        
        // Floor
<span class="nc" id="L256">        Vector min = new Vector(xmin, -1f, zmin);</span>
<span class="nc" id="L257">        Vector max = new Vector(xmax, 0, zmax);</span>
<span class="nc" id="L258">        Solid floor = new Solid();</span>
        
<span class="nc" id="L260">        floor.model = Model.buildFloor(min, max, floorFile);</span>
<span class="nc" id="L261">        floor.model.compileBuffers();</span>
        
<span class="nc" id="L263">        floor.aabb = new AABB(floor.position, min, max);</span>
<span class="nc" id="L264">        floor.culling = false;</span>
        
<span class="nc" id="L266">        solids.add(floor);</span>
        
        // ceiling        
<span class="nc" id="L269">        Solid ceil = new Solid();</span>
        
<span class="nc" id="L271">        ceil.model = Model.buildCeiling(</span>
                new Vector(xmin, Level.WALL_HEIGHT, zmin),
                new Vector(xmax, Level.WALL_HEIGHT + 0.1f, zmax),
                ceilingFile);
<span class="nc" id="L275">        ceil.model.compileBuffers();</span>
<span class="nc" id="L276">        ceil.culling = false;</span>
        
<span class="nc" id="L278">        solids.add(ceil);</span>
        
<span class="nc" id="L280">    }</span>
    
    /** Loads level from file
     * 
     * @param file containing the level
     * @return 
     */
    public static Level fromFile(String file) {
        
<span class="nc" id="L289">        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {</span>
<span class="nc" id="L290">            Level level = new Level();</span>
            
            String line; String[] tokens;
            
<span class="nc bnc" id="L294" title="All 2 branches missed.">            while ((line = reader.readLine()) != null) {</span>
                // Split line
<span class="nc" id="L296">                tokens = line.split(&quot;\\s+&quot;); </span>
                
<span class="nc bnc" id="L298" title="All 4 branches missed.">                if(line.length() == 0 || tokens.length &lt; 1)</span>
<span class="nc" id="L299">                    continue;</span>
                
<span class="nc bnc" id="L301" title="All 58 branches missed.">                switch (tokens[0].toLowerCase()) {</span>
<span class="nc" id="L302">                    case &quot;camera&quot;: break;</span>
                    case &quot;wall&quot;:
<span class="nc" id="L304">                        float w = Float.parseFloat(tokens[3]);</span>
<span class="nc" id="L305">                        float h = Float.parseFloat(tokens[4]);</span>
                        
<span class="nc" id="L307">                        Vector min = new Vector(-w/2, 0, -h/2);</span>
<span class="nc" id="L308">                        Vector max = new Vector(w/2, WALL_HEIGHT, h/2);</span>
                        
<span class="nc" id="L310">                        Model model =</span>
                                Model.buildWall(min, max, &quot;level/wall.png&quot;);
                        
<span class="nc" id="L313">                        model.compileBuffers();</span>
<span class="nc" id="L314">                        model.releaseRawData();</span>
                        
<span class="nc" id="L316">                        Solid wall = new Solid();</span>
                        
<span class="nc" id="L318">                        wall.aabb = new AABB(wall.position, min, max);</span>
<span class="nc" id="L319">                        wall.model = model;</span>
<span class="nc" id="L320">                        wall.position.set(</span>
                                Float.parseFloat(tokens[1]), 0,
                                Float.parseFloat(tokens[2]));
<span class="nc" id="L323">                        wall.culling = false;</span>
                        
<span class="nc" id="L325">                        level.addSolid(wall);</span>
                        
<span class="nc" id="L327">                        break;</span>
                    case &quot;light&quot;:
                        
<span class="nc" id="L330">                        level.addNewLight()</span>
                                .setPosition(Float.parseFloat(tokens[1]),
                                             WALL_HEIGHT - 0.2f,
                                             Float.parseFloat(tokens[2]))
                                .setColor(Float.parseFloat(tokens[3]),
                                          Float.parseFloat(tokens[4]))
                                .setIntensity(Float.parseFloat(tokens[5]) * 5)
                                .setEnvironmentLight();
                        
<span class="nc" id="L339">                        break;</span>
                    case &quot;enemy&quot;:
<span class="nc" id="L341">                        Enemy enemy = new Enemy(level);</span>
                        
<span class="nc" id="L343">                        enemy.setPosition(Float.parseFloat(tokens[1]), 0,</span>
                                           Float.parseFloat(tokens[2]));
                        
<span class="nc" id="L346">                        enemy.setRotation(0, Float.parseFloat(tokens[3]), 0);</span>
<span class="nc" id="L347">                        enemy.selectNearestWaypoint();</span>
                        
<span class="nc" id="L349">                        level.addEntity(enemy);</span>
                        
<span class="nc" id="L351">                        break;</span>
                    case &quot;waypoint&quot;:
<span class="nc" id="L353">                        Waypoint waypoint = new Waypoint(new Vector(</span>
                                Float.parseFloat(tokens[1]), 0,
                                Float.parseFloat(tokens[2])));
                        
<span class="nc" id="L357">                        level.addWaypoint(waypoint);</span>
                        
<span class="nc" id="L359">                        break;</span>
                    case &quot;start&quot;:
<span class="nc" id="L361">                        level.startPoint.set(Float.parseFloat(tokens[1]),</span>
                                             Float.parseFloat(tokens[3]),
                                             Float.parseFloat(tokens[2]));
                        
<span class="nc" id="L365">                        break;</span>
                    case &quot;exit&quot;:
<span class="nc" id="L367">                        Elevator elevator = new Elevator(</span>
                                                Integer.parseInt(tokens[3]));
                        
<span class="nc" id="L370">                        elevator.position.set(Float.parseFloat(tokens[1]), 0,</span>
                                              Float.parseFloat(tokens[2]));
                        
<span class="nc" id="L373">                        level.addUsable(elevator);</span>
                        
<span class="nc" id="L375">                        break;</span>
                    case &quot;door&quot;:
<span class="nc" id="L377">                        Door door = new Door(Integer.parseInt(tokens[3]) + 2);</span>
                        
<span class="nc" id="L379">                        door.position.set(Float.parseFloat(tokens[1]), 0,</span>
                                          Float.parseFloat(tokens[2]));
                        
<span class="nc" id="L382">                        level.addUsable(door);</span>
                        
<span class="nc" id="L384">                        break;</span>
                    case &quot;prop&quot;:
<span class="nc" id="L386">                        Prop prop = new Prop(tokens[1],</span>
                                      (Integer.parseInt(tokens[5]) + 1) % 4);
                        
<span class="nc" id="L389">                        prop.position.set(Float.parseFloat(tokens[2]),</span>
                                          Float.parseFloat(tokens[3]),
                                          Float.parseFloat(tokens[4]));
                        
<span class="nc" id="L393">                        level.addSolid(prop);</span>
                        
<span class="nc" id="L395">                        break;</span>
                    case &quot;needle&quot;:
<span class="nc" id="L397">                        Pickup needle = new Needle(level);</span>
                        
<span class="nc" id="L399">                        needle.position.set(Float.parseFloat(tokens[1]), 0,</span>
                                            Float.parseFloat(tokens[2]));
<span class="nc" id="L401">                        needle.findAltitude();</span>
                        
<span class="nc" id="L403">                        level.addUsable(needle);</span>
                        
<span class="nc" id="L405">                        break;</span>
                    case &quot;infusion&quot;:
<span class="nc" id="L407">                        Pickup infusion = new Infusion(level);</span>
                        
<span class="nc" id="L409">                        infusion.position.set(Float.parseFloat(tokens[1]), 0,</span>
                                              Float.parseFloat(tokens[2]));
<span class="nc" id="L411">                        infusion.findAltitude();</span>
                        
<span class="nc" id="L413">                        level.addUsable(infusion);</span>
                        
<span class="nc" id="L415">                        break;</span>
                    case &quot;source&quot;:
<span class="nc" id="L417">                        Sound.getResource(tokens[1]).setGain(0.1f)</span>
                            .setLooping(true)
                            .setPosition(Float.parseFloat(tokens[2]),
                                         Float.parseFloat(tokens[3]),
                                         Float.parseFloat(tokens[4])).play();
                        
<span class="nc" id="L423">                        break;</span>
                    case &quot;link&quot;:
<span class="nc" id="L425">                        Waypoint.link(</span>
                            level.waypoints.get(Integer.parseInt(tokens[1])),
                            level.waypoints.get(Integer.parseInt(tokens[2])));
                        
<span class="nc" id="L429">                        break;</span>
                    case &quot;nextlevel&quot;:
<span class="nc" id="L431">                        level.nextLevel = tokens[1];</span>
                        
<span class="nc" id="L433">                        break;</span>
                    default: // Incompatible line                        
<span class="nc" id="L435">                        Logger.error(&quot;Could not read LVL file &quot; + file);</span>
<span class="nc" id="L436">                        Logger.error(&quot;Invalid line &gt; &quot; + line);</span>
<span class="nc" id="L437">                        return null;</span>
                }
            }
            
            // Generate floor
<span class="nc" id="L442">            level.generateFloorCeiling(&quot;level/floor.png&quot;, &quot;level/ceiling.png&quot;);</span>
            
<span class="nc" id="L444">            return level;</span>
<span class="nc bnc" id="L445" title="All 12 branches missed.">        } catch(IOException e) { e.printStackTrace(); return null; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312101107</span></div></body></html>