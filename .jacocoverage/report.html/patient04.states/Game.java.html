<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;EWI3620TU-GROUP04&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">patient04.states</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package patient04.states;

import org.lwjgl.input.Keyboard;
import patient04.Main;
import patient04.resources.Texture;
import patient04.level.Player;
import patient04.utilities.Timer;
import patient04.level.Level;
import patient04.resources.Model;
import patient04.math.Matrix;
import patient04.rendering.Renderer;

import org.lwjgl.input.Mouse;
import org.lwjgl.opengl.Display;
import patient04.level.Pauser;
import patient04.level.Tutorial;
import patient04.math.Vector;
import patient04.resources.Sound;
import patient04.utilities.Input;
import patient04.utilities.Logger;
import patient04.utilities.Utils;


<span class="nc" id="L24">public class Game implements State, Input.Listener {</span>
<span class="nc" id="L25">    public String loadLevel = &quot;&quot;;</span>
    public boolean enableTutorial;
    
    private Renderer renderer;
    
    private Input controller;
    private Pauser pauser;
    private Tutorial tutorial;
    
    private Timer timer;
    private Level level;
    private Player player;
    
    @Override
    public void initialize() {
<span class="nc" id="L40">        Utils.showLoading();</span>
        
        // Create a new Renderer
<span class="nc" id="L43">        renderer = new Renderer();</span>
        
<span class="nc" id="L45">        renderer.projection = Matrix.projPerspective(</span>
               70, (float) Display.getWidth() / Display.getHeight(), .1f, 50);
        
        // Create a new timer
<span class="nc" id="L49">        timer = new Timer();</span>
        
        // Create a new maze and player
<span class="nc" id="L52">        level = Level.fromFile(&quot;res/levels/&quot; +loadLevel);</span>

        // Add player to level
<span class="nc" id="L55">        player = level.newPlayer();</span>
       
        // Set player at start point
<span class="nc" id="L58">        player.setPosition(level.startPoint.x, 0, level.startPoint.z);</span>
<span class="nc" id="L59">        player.setRotation(0, level.startPoint.y - 90, 0);</span>
        
        // Pauser
<span class="nc" id="L62">        pauser = new Pauser();</span>
<span class="nc" id="L63">        pauser.setPaused(false);</span>
        
        // Tutorial
<span class="nc" id="L66">        tutorial = new Tutorial();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (enableTutorial) tutorial.stage = 0;</span>
        
        // Input controller
<span class="nc" id="L70">        controller = new Input();</span>
        
        // Add listeners in order of priority
<span class="nc" id="L73">        controller.addListener(pauser);</span>
<span class="nc" id="L74">        controller.addListener(tutorial);</span>
<span class="nc" id="L75">        controller.addListener(this);</span>
<span class="nc" id="L76">        controller.addListener(player);</span>
        
        // TODO remove
//        Sound.getResource(&quot;monitor.wav&quot;).setGain(0.1f)
//                .setLooping(true).setPosition(7.3f, 1f, 5.4f).play();
<span class="nc" id="L81">    }</span>

    @Override
    public void update() {
        // Obtain frame time
<span class="nc" id="L86">        float dt = timer.deltaTime() * 0.001f;</span>
        
        // Set frame title to performance information
//        Display.setTitle(
//                String.format(&quot;Frame update time: %.3fs&quot;, dt) +
//                &quot; / Vsync: &quot; + (Main.vsyncEnabled ? &quot;Enabled&quot; : &quot;Disabled&quot;));
        
        // Handle keyboard and mouse events
<span class="nc" id="L94">        controller.processInput();</span>
        
        // Update game dynamics if the game is not paused
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if(!pauser.isPaused()) {</span>
<span class="nc" id="L98">            level.update(dt);</span>
<span class="nc" id="L99">            tutorial.update(dt);</span>
            
            // Also update score timer
<span class="nc" id="L102">            Main.scoreTime += dt;</span>
        }
<span class="nc" id="L104">    }</span>
    
    @Override
    public boolean handleMouseEvent() {
        // Event unhandled
<span class="nc" id="L109">        return Input.UNHANDLED;</span>
    }

    @Override
    public boolean handleKeyboardEvent() {
        // (Un)pause the game
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if(Input.keyboardKey(Keyboard.KEY_ESCAPE, true)) {</span>
<span class="nc" id="L116">            pauser.setPaused(true);</span>
            
<span class="nc" id="L118">            return Input.HANDLED;</span>
        }
        
        
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if(Input.keyboardKey(Keyboard.KEY_R, true)) {</span>
<span class="nc" id="L123">            Game game = (Game) Main.requestNewState(Main.States.GAME);</span>
<span class="nc" id="L124">            game.loadLevel = loadLevel;</span>
            
<span class="nc" id="L126">            return Input.HANDLED;</span>
        }
        
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if(Input.keyboardKey(Keyboard.KEY_L, true)) {</span>
<span class="nc" id="L130">            Vector position = player.getPosition().add(0, 2, 0);</span>
            
            // Create a new light at player position
<span class="nc" id="L133">            level.addNewLight().setColor((float) Math.random(), 0.7f)</span>
                    .setIntensity(15).setEnvironmentLight()
                    .setPosition(position.x, position.y, position.z);
            
<span class="nc" id="L137">            Logger.debug(&quot;Light placed at: &quot; + position);</span>
            
<span class="nc" id="L139">            return Input.HANDLED;</span>
        }
        
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if(Input.keyboardKey(Keyboard.KEY_F12, true)) {</span>
<span class="nc" id="L143">            renderer.makeScreenshots();</span>
        }
        
        // Unhandled event
<span class="nc" id="L147">        return Input.UNHANDLED;</span>
    }
    
    @Override
    public void render() {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if(!pauser.isPaused()) {</span>
            // Set view matrix
<span class="nc" id="L154">            renderer.view = player.getFirstPersonView();</span>

            // Change to geometry pass
<span class="nc" id="L157">            renderer.geometryPass();</span>

            // Draw level geometry
<span class="nc" id="L160">            level.drawGeometry(renderer);</span>

            // Change to lighting pass
<span class="nc" id="L163">            renderer.lightingPass();</span>

<span class="nc" id="L165">            level.drawLights(renderer);</span>
        }
        
        // Do a gui pass
<span class="nc" id="L169">        renderer.guiPass(player);</span>
        
        // Debug navigation grid
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if(Keyboard.isKeyDown(Keyboard.KEY_P))</span>
<span class="nc" id="L173">            level.drawNavPoints(renderer);</span>
        
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if(pauser.isPaused()) {</span>
<span class="nc" id="L176">            pauser.draw();</span>
        } else {
<span class="nc" id="L178">            tutorial.draw();</span>
        }
        
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (Keyboard.isKeyDown(Keyboard.KEY_B))</span>
<span class="nc" id="L182">            renderer.debugPass();</span>
<span class="nc" id="L183">    }</span>
    
    @Override
    public void destroy() {
        // Clean up level
<span class="nc" id="L188">        level.cleanup();</span>
        
        // Delete renderer
<span class="nc" id="L191">        renderer.dispose();</span>
        
        // Clean up textures and models
<span class="nc" id="L194">        Texture.disposeResources();</span>
<span class="nc" id="L195">        Model.disposeResources();</span>
<span class="nc" id="L196">        Sound.disposeResources();</span>
        
        // Un-grab mouse
<span class="nc" id="L199">        Mouse.setGrabbed(false);</span>
<span class="nc" id="L200">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312101107</span></div></body></html>